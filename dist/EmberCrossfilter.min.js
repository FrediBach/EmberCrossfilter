/*! EmberCrossfilter by Adam Timberlake created on 2013-06-06 */
window.EmberCrossfilter=Ember.Mixin.create({_crossfilter:null,activeFilters:Ember.A([]),init:function(){this._super(),Ember.set(this,"activeFilters",Ember.A([])),this._createCrossfilter()},_createCrossfilter:Ember.observer(function(){Ember.assert("Controller implements EmberCrossfilter but `filterMap` has not been specified.",!!this.filterMap);var a=Ember.get(this,"content"),b=!!Ember.get(this,"_crossfilter"),c=!a.length;if(c||b)return!1;if(this._crossfilter=crossfilter(a),this._createDimensions(),Ember.get(this,"sort.sortProperty")){var d=Ember.get(this,"sort.sortProperty"),e=Ember.get(this,"sort.isAscending");Ember.set(this,"content",this._sortedContent(a,d,e))}return!0},"content.length"),addFilter:function(a,b){var c=this.filterMap[a];c.value=b,Ember.isArray(b)&&(c.value=[b[0],b[1]]),this._updateContent(c)},removeFilter:function(a){this.addFilter(a,null)},clearAllFilters:function(){var a=(new Date).getTime();for(var b in this.filterMap)if(this.filterMap.hasOwnProperty(b)){var c=this.filterMap[b],d=this["_dimension%@".fmt(c.dimension.capitalize())];d.filterAll()}Ember.get(this,"activeFilters").clear(),this._applyContentChanges(),Ember.debug("Crossfilter Time: %@ millisecond(s)".fmt((new Date).getTime()-a))},sortContent:function(a,b){var c=this._sortedContent(Ember.get(this,"content"),a,b);Ember.set(this,"content",c),Ember.assert("In order to sort you must have a `sort` object defined.",!!Ember.get(this,"sort")),Ember.assert("You must define `sortProperty` in your `sort` object.",!!Ember.get(this,"sort.sortProperty")),Ember.set(this,"sort.sortProperty",a),Ember.set(this,"sort.isAscending",b),this.notifyPropertyChange("content")},isActiveFilter:function(a){return-1!==$.inArray(a,Ember.get(this,"activeFilters"))},_updateContent:function(a){var b=(new Date).getTime(),c=this["_dimension%@".fmt(a.dimension.capitalize())];if(Ember.isNone(a.value)&&"filterFunction"!==a.method)Ember.get(this,"activeFilters").removeObject(a.name),c.filterAll();else switch(Ember.get(this,"activeFilters").pushObject(a.name),a.method){case"filterInArray":this._setFilterInArray(a,c);break;case"filterRangeMin":this._setFilterRangeMin(a,c);break;case"filterRangeMax":this._setFilterRangeMax(a,c);break;case"filterFunction":this._setFilterFunction(a,c);break;default:c[a.method](a.value)}this._applyContentChanges(),Ember.debug("Crossfilter Time: %@ millisecond(s)".fmt((new Date).getTime()-b))},_applyContentChanges:function(){var a=Ember.get(this,"_dimensionId"),b=a.filterAll().top(1/0);Ember.get(this,"sort.sortProperty")&&(b=this._sortedContent(b,Ember.get(this,"sort.sortProperty"),Ember.get(this,"sort.isAscending"))),Ember.set(this,"content",b)},_createDimensions:function(){var a=function(a,b){this[a]||Object.defineProperty(this,a,{enumerable:!1,configurable:!1,writable:!1,value:this._crossfilter.dimension(function(a){return a[b]})})};a.apply(this,["_dimensionId","id"]);for(var b in this.filterMap)if(this.filterMap.hasOwnProperty(b)){this.filterMap[b].name=b,this.filterMap[b].value=null,b=this.filterMap[b];var c="_dimension%@".fmt(b.dimension.capitalize());a.apply(this,[c,b.property])}},_sortedContent:function(a,b,c){var d=crossfilter.quicksort.by(function(a){return a[b]}),e=d(a,0,a.length);return c||(e=e.reverse()),e},_setFilterInArray:function(a,b){b.filterFunction(function(b){return-1!==$.inArray(a.value,b)})},_setFilterFunction:function(a,b){var c="_apply%@".fmt(a.dimension.capitalize());Ember.assert("Crossfilter `filterFunction` expects a callback named `%@`.".fmt(c),!!Ember.canInvoke(this,c)),b.filterFunction(this[c])},_setFilterRangeMin:function(a,b){var c=a.name.replace("min","max");Ember.assert("You must specify define the `max` dimension for %@".fmt(a.name),!!this.filterMap[c]);var d=this.filterMap[c].value;b.filterRange([a.value,d||1/0])},_setFilterRangeMax:function(a,b){var c=a.name.replace("max","min");Ember.assert("You must specify define the `min` dimension for %@".fmt(a.name),!!this.filterMap[c]);var d=this.filterMap[c].value;b.filterRange([d||-1/0,a.value])}});